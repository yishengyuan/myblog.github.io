
```js
//buyers

// 执行购买

function executeSale(uint256 tokenId) payable external {

//tokenId is listed

ListedToken storage token=idToListedToken[tokenId];

require(token.curentlyListed,"nft must listed");

//msg.value=price;

require(msg.value==token.price,"price not enough");

  

address payable seller=token.seller;

//change owner

token.seller=payable(msg.sender);

//transfer nft->msg.sender

// address(this) 是合约地址 marketplace 合约地址

// msg.sender 是买家地址. nft 要从合约地址转给买家地址

_transfer(address(this),msg.sender,tokenId);

  

//price->seller

// 买家把钱转给卖家 erc20

// 也可以使用erc20 主链币没有approve 和 非主链币有approve approve是可以确认是否有足够额度

seller.transfer(token.price);

//listprice->owner 手续费给扣除了

// address(this) marketplace 合约地址

// owner() 是 版权持有者

payable(owner()).transfer(listPrice);

  

_itemsSold.increment();

  

}
```

```js
//seller

// tokenURI 这个是从 IPFS 上获取的

function createToken(string memory tokenURI, uint256 price) payable external returns(uint256){

//price>0

require(price>0,"price must greater than zero");

//msg.value=listPrice

require(msg.value==listPrice,"need send enough list price");

//mint

_tokenIds.increment();

// 第一次 mint 出来的 tokenId 是 1

uint256 newTokenId=_tokenIds.current();

// 保存 tokenURI

_safeMint(msg.sender,newTokenId);

// 设置 tokenURI

_setTokenURI(newTokenId,tokenURI);

//create listToken 
// payable (address(this)) 谁创建的也就是owner就是谁 
// payable (msg.sender)  seller一开始就是创建者
idToListedToken[newTokenId]=ListedToken(newTokenId,payable (address(this)),payable (msg.sender),price,true);

//transfer token->market

// 把 NFT 转移到合约地址 那到底是转多少呢？ 是 newTokenId

_transfer(msg.sender,address(this),newTokenId);

//emit event

emit TokenListedSuccess(newTokenId,address(this),msg.sender,price,true);

return _tokenIds.current();

}


```

报错

![[Pasted image 20251111181351.png]]