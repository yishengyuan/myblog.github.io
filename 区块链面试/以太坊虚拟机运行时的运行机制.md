# ✅ 一、EVM（Ethereum Virtual Machine）是什么？

EVM 是以太坊的**沙盒式、图灵完备的状态机**，负责：

- 执行交易/智能合约字节码
    
- 修改链上的状态（账户、存储、余额）
    
- 计算 gas 消耗并收费
    
- 保证所有节点执行结果一致（确定性）
    

核心理解：  
**EVM = 状态机 + 执行引擎 + Gas 计费器**。

---

# ✅ 二、EVM 的核心运行机制（面试重点）

下面按照**执行顺序**讲解，这是最高分的回答方式。

---

# **1️⃣ 交易进入 EVM 前的准备**

每个节点收到交易后，先进行：

### ✓ 交易合法性验证

- 签名有效（ECDSA）
    
- nonce 正确（防重放）
    
- Gas Limit 足够
    
- sender 余额足够支付（gas limit × gas price）
    

通过后交易进入 **pending pool** → 按 gas 排序等待打包。

---

# **2️⃣ 交易在区块中被执行：EVM 状态机启动**

EVM 是一个**状态转换函数**：

`state' = ƒ(state, transaction)`

也就是：给定交易和之前的世界状态，生成一个新状态。

---

# **3️⃣ 执行环境（Execution Context）创建**

每次执行一个智能合约，EVM 会创建执行上下文：

包含：

- `msg.sender`
    
- `msg.value`
    
- `msg.data`（输入参数）
    
- `gas available`
    
- 当前合约地址
    
- 链的环境信息（block number, timestamp, baseFee 等）
    

这个上下文会一路传递。

---

# **4️⃣ EVM 字节码开始执行：基于 Stack 的指令机**

EVM 是 **栈式虚拟机（Stack-based VM）**，不是寄存器式。

关键要点：

- **最大栈深 1024**
    
- 所有计算都在栈中完成  
    → 例如 ADD 会 pop 两个数 → push 结果
    
- 指令都是固定长度 OP Code（1 字节）
    
- 逐条解释执行（非 JIT）
    

举例：

`PUSH1 0x10   PUSH1 0x20   ADD`

运行过程：

|指令|栈变化|
|---|---|
|PUSH1 0x10|[0x10]|
|PUSH1 0x20|[0x10, 0x20]|
|ADD|[0x30]|

---

# **5️⃣ 内存、存储、栈的区别（面试必问）**

|结构|生命周期|持久化|成本|
|---|---|---|---|
|**Stack**|执行期间|否|便宜|
|**Memory**|执行期间|否|增长成本递增（quadratic cost）|
|**Storage**|合约长期状态|是（写入链）|**最贵**（SSTORE）|

面试官 90% 会继续问：**为什么 storage 贵？**  
答：因为写 storage 需要更新 Merkle Patricia Trie（状态树），全网共识，成本高。

---

# **6️⃣ Gas 计费机制执行中实时扣费**

每执行一条 OPCode 都会扣 gas，如：

| 指令     | 花费               |
| ------ | ---------------- |
| ADD    | 3 gas            |
| SLOAD  | 100 gas          |
| SSTORE | 20000 / 5000 gas |
| CALL   | 可变，最高            |

如果 gas 不够 → **out-of-gas → 整个执行回滚**，但 gas 已经消耗。

> 重要考点：  
> “回滚状态，但不回滚 gas”。

---

# **7️⃣ 合约调用（CALL / DELEGATECALL）运行机制**

EVM 支持类似多进程的执行：

- **CALL**：调用其他合约，新的上下文
    
- **DELEGATECALL**：使用外部合约逻辑，但保持 caller 的 storage（代理合约）
    
- **STATICCALL**：只读模式，禁止 SSTORE
    

CALL 会创建一个新的调用帧（call frame）。

所有调用形成一棵调用栈，最大深度 1024。

---

# **8️⃣ Return / Revert 结束执行**

### **返回：RETURN**

- 正常执行结束
    
- 返回 output（ABI 编码）
    

### **失败：REVERT**

- 状态回滚
    
- gas 按已使用扣除
    
- error data 返回给外层
    

---

# **9️⃣ 最终状态写入区块链**

执行结束后：

- 更新账户余额、存储
    
- 更新日志（logs，用于事件）
    
- 收集触发的内联消息（internal tx）
    

矿工／验证者将新的世界状态（state root）写入区块。

---

# 🔟 所有节点重复执行 → 共识保证一致性

以太坊每个节点都会：

- 按相同顺序执行同样的交易
    
- EVM 确保 deterministic（确定性）
    

最终所有节点得到同一个 state root，达成共识。

---

# ✅ 三、15 秒答题模板（结构、逻辑完整）

> EVM 是一个基于栈的确定性状态机。  
> 每个交易进入区块后，会创建执行上下文，然后逐条解释 EVM 字节码，通过栈、内存、存储驱动执行。  
> 每条指令都会消耗 gas，并在 stack/memory/storage 之间操作数据。  
> CALL/DELEGATECALL 用于合约之间调用，最终执行产生新的状态树并写入区块。  
> 所有节点按同样顺序执行相同字节码，最终得到一致的状态 root，实现链上共识。