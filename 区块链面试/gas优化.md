## **1ï¸âƒ£ é¢è¯•é¢˜ï¼šSolidity ä¸­æœ‰å“ªäº›å¸¸è§çš„ Gas ä¼˜åŒ–æ‰‹æ®µï¼Ÿ**

### â­ æ ‡å‡†é«˜åˆ†å›ç­”ï¼š

å¯ä»¥ä»ä¸‰ä¸ªç»´åº¦å›ç­”ï¼š**å­˜å‚¨ã€è®¡ç®—ã€ç»“æ„è®¾è®¡**ã€‚

### âœ” ç¤ºä¾‹ç­”æ¡ˆï¼š

**ï¼ˆ1ï¼‰Storage ä¼˜åŒ–ï¼ˆæœ€è´µçš„éƒ¨åˆ†ï¼‰**

- å°½é‡å‡å°‘ `storage` çš„è¯»å†™ï¼Œä½¿ç”¨ `memory` æˆ– `calldata` æ›¿ä»£
    
- å¤šä¸ª `uint8/uint16/uint32` æ”¾è¿›ä¸€ä¸ª `uint256`ï¼ˆstorage packingï¼‰
    
- è¿ç»­æ˜ å°„æ“ä½œæ—¶ï¼Œå…ˆç”¨å±€éƒ¨å˜é‡ç¼“å­˜ `mapping` æŸ¥è¯¢å€¼å†å†™å›
    

**ï¼ˆ2ï¼‰è®¡ç®—ä¼˜åŒ–ï¼ˆå‡å°‘è®¡ç®—æ­¥éª¤ï¼‰**

- ä½¿ç”¨ `unchecked` åŒ…è£…ä¸ä¼šæº¢å‡ºçš„è‡ªå¢/åŠ æ³•
    
- çŸ­è·¯æ±‚å€¼ï¼ˆ`if (a && b)`ï¼‰
    
- é¿å…é‡å¤è®¡ç®—ï¼ŒæŠŠå‡½æ•°ç»“æœç¼“å­˜ä¸ºå±€éƒ¨å˜é‡
    
- `++i` æ¯” `i++` æ›´çœ gas
    

**ï¼ˆ3ï¼‰ç»“æ„è®¾è®¡ä¼˜åŒ–ï¼ˆä»æ¶æ„å±‚é¢å‡ gasï¼‰**

- ä½¿ç”¨ `immutable` å’Œ `constant` å˜é‡ï¼ˆå‡å°‘ storage è¯»ï¼‰
    
- ä½¿ç”¨ `bytes32` è€Œä¸æ˜¯ `string` æˆ– `bytes`ï¼ˆæ›´ä¾¿å®œï¼‰
    
- äº‹ä»¶ä¸­é¿å…å¤§é‡å‚æ•°
    
- è°ƒç”¨å¤–éƒ¨åˆçº¦å°½é‡æ‰¹å¤„ç†ï¼Œå‡å°‘å¤šæ¬¡è°ƒç”¨
    

æœ€åä¸€å¥æ€»ç»“ï¼š

> Gas ä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯å‡å°‘ storageã€å‡å°‘è®¡ç®—æ­¥éª¤ã€å‡å°‘å¤–éƒ¨è°ƒç”¨ã€‚

## **2ï¸âƒ£ é¢è¯•é¢˜ï¼šstorage æ¯” memory æ›´è´µå—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ**

### â­ é«˜åˆ†å›ç­”ï¼š

æ˜¯çš„ï¼Œ**storage æ˜¯ EVM ä¸­æœ€è´µçš„æ“ä½œ**ã€‚

åŸå› æ˜¯ï¼š

- storage æ•°æ®å†™å…¥éœ€è¦æŒä¹…åŒ–åˆ°é“¾ä¸Š
    
- éœ€è¦æ›´æ–° Merkle Patricia Trie
    
- å¯èƒ½äº§ç”Ÿ SSTORE refundsï¼ˆå†™0â†’é0/é0â†’0ï¼‰
    
- è®¡ç®—é‡å¤§ã€çŠ¶æ€é‡å¤§ï¼Œä¼šå¢åŠ åŒºå—å¤§å°
    

æ€»ç»“ä¸€å¥ï¼š

> storage æ˜¯æŒä¹…åŒ–å­˜å‚¨ï¼Œå†™ä¸€æ¬¡å¯èƒ½èŠ±è´¹å‡ ä¸‡ gasï¼›memory æ˜¯ä¸´æ—¶çš„ï¼Œåªåœ¨äº¤æ˜“æ‰§è¡ŒæœŸé—´æœ‰æ•ˆã€‚


## **3ï¸âƒ£ é¢è¯•é¢˜ï¼šå¦‚ä½•å‡å°‘ storage å†™æ“ä½œï¼Ÿ**

### âœ” é«˜åˆ†å›ç­”ï¼š

- å¤šè¯»ã€å°‘å†™ï¼šå°†å€¼è¯»å‡ºåˆ° memoryï¼Œç„¶ååœ¨ memory é‡Œåšè¿ç®—ï¼Œæœ€åä¸€æ¬¡æ€§å†™å›
    
- æŠŠå¤šä¸ªå­—æ®µæ‰“åŒ…è¿›ä¸€ä¸ª slotï¼ˆå¦‚ uint8 + uint8 + boolï¼‰
    
- é¿å…å¾ªç¯é‡Œé¢‘ç¹å†™å…¥ mapping / array
    
- å¦‚æœæ— éœ€é•¿æœŸè®°å½•ï¼Œç”¨ event æ›¿ä»£ storageï¼ˆæ—¥å¿—æ¯”å†™ storage ä¾¿å®œï¼‰

## **4ï¸âƒ£ é¢è¯•é¢˜ï¼šå¾ªç¯ä¸­å¦‚ä½•åš Gas ä¼˜åŒ–ï¼Ÿ**

### â­ é«˜åˆ†å›ç­”ï¼š

- å¾ªç¯è®¡æ•°ç”¨ `unchecked` åŒ…è£…
    
- ç¼“å­˜æ•°ç»„é•¿åº¦ `uint len = arr.length;`
    
- å¤šä¸ª `storage` è¯»å–æ”¹æˆ `memory` å˜é‡ç¼“å­˜
    
- å°½é‡ä½¿ç”¨ `calldata` é¿å…æ‹·è´
    
- å¤§å¾ªç¯è¦æ‹†åˆ†ä¸ºæ‰¹å¤„ç†ï¼ˆé¿å… gas ä¸Šé™ï¼‰
## **5ï¸âƒ£ é¢è¯•é¢˜ï¼šä¸ºä»€ä¹ˆ `calldata` æ¯” `memory` æ›´çœ Gasï¼Ÿ**

### âœ” é«˜åˆ†å›ç­”ï¼š

- `calldata` æ˜¯åªè¯»çš„ï¼Œä¸éœ€è¦åˆ†é…å†…å­˜
    
- ABI å‚æ•°ç›´æ¥ä» calldata åŒºåŸŸè¯»å–
    
- `memory` éœ€è¦å¼€è¾Ÿç©ºé—´ã€æ‹·è´æ•°æ®ã€ç»´æŠ¤æŒ‡é’ˆ
    

ä¸€å¥è¯ï¼š

> å¤–éƒ¨å‡½æ•°å‚æ•°èƒ½ç”¨ `calldata` å°±ä¸è¦ç”¨ `memory`ã€‚

## **6ï¸âƒ£ é¢è¯•é¢˜ï¼šSolidity ä¸­ struct å¦‚ä½•ä¼˜åŒ– Gasï¼Ÿ**

### â­ é«˜åˆ†å›ç­”ï¼š

- å°ç±»å‹ç´§å‡‘æ’åˆ—ï¼ˆå¦‚ `uint128 + uint64 + uint64`ï¼‰ä¿è¯å ç”¨ä¸€ä¸ª slot
    
- bool æ”¹ç”¨ uint8
    
- ä¿®æ”¹ struct å­—æ®µæ—¶ï¼Œå°½é‡ä¸€æ¬¡æ€§ä» storage å–å‡ºï¼Œæ”¹å®Œå†å†™å›
    
- å¦‚æœ struct åªä¸´æ—¶ä½¿ç”¨ï¼Œä¸è¦æ”¾ storage
## **7ï¸âƒ£ é¢è¯•é¢˜ï¼š`constant` å’Œ `immutable` ä»€ä¹ˆåŒºåˆ«ï¼Ÿä¸ºä½•èŠ‚çœ Gasï¼Ÿ**

### âœ” é«˜åˆ†å›ç­”ï¼š

- `constant` ç¼–è¯‘æ—¶ç¡®å®šï¼Œç›´æ¥å†™å…¥å­—èŠ‚ç 
    
- `immutable` éƒ¨ç½²æ—¶ç¡®å®šï¼Œå­˜å‚¨åœ¨ code åŒºåŸŸï¼Œä¸åœ¨ storage ä¸­
    
- ä¸¤è€…éƒ½é¿å…äº† storage è¯»ï¼Œçœä¸‹å¤§é‡ gasï¼ˆä¸€æ¬¡ SLOAD å°± 2100 gasï¼‰
## **8ï¸âƒ£ é¢è¯•é¢˜ï¼šäº‹ä»¶æ—¥å¿—ä¹Ÿèƒ½ä¼˜åŒ– Gas å—ï¼Ÿ**

### â­ é«˜åˆ†å›ç­”ï¼š

èƒ½ã€‚  
ç›¸åŒä¿¡æ¯ï¼Œäº‹ä»¶æ¯” storage ä¾¿å®œ 10ï½20 å€ã€‚

ä¾‹å¦‚å¸¸è§ä¼˜åŒ–ï¼š

- ä¸éœ€è¦é“¾ä¸Šæ°¸ä¹…è®°å½•çš„æ•°æ®ï¼Œå†™å…¥ event è€Œä¸æ˜¯ storage
    
- event å‚æ•°å°½é‡ä½¿ç”¨ `indexed`ï¼Œä½†ä¸è¦è¶…è¿‡ 3 ä¸ªï¼ˆlog topic æœ‰é™åˆ¶ï¼‰
## **9ï¸âƒ£ å¦‚æœä½ å†™è¿‡åˆçº¦ï¼Œå¦‚ä½•å±•ç¤ºâ€œå®æˆ˜ Gas ä¼˜åŒ–â€ï¼Ÿï¼ˆè¶…åŠ åˆ†å›ç­”ï¼‰**

ä½ å¯ä»¥è¿™æ ·å›ç­”ï¼š

> æˆ‘ä¹‹å‰ä¼˜åŒ–è¿‡ä¸€ä¸ª NFT æˆ–ä»£å¸çš„åˆçº¦ï¼ˆä¾‹å¦‚ ERC721A é£æ ¼ï¼‰ã€‚
> 
> ä¼˜åŒ–ç‚¹åŒ…æ‹¬ï¼š
> 
> 1. ä½¿ç”¨ `packed data` å°†å¤šä¸ªå­—æ®µå¡è¿›ä¸€ä¸ª uint256
>     
> 2. ç”¨ `unchecked` åŒ…è£…è‡ªå¢
>     
> 3. å°† owner æŸ¥è¯¢ç¼“å­˜ä¸ºå±€éƒ¨å˜é‡é¿å…é‡å¤ SLOAD
>     
> 4. ä½¿ç”¨ `calldata` ä½œä¸ºæ‰¹é‡ mint å‚æ•°
>     
> 5. æŠŠä¸éœ€è¦é•¿æœŸä¿ç•™çš„è®°å½•ç§»åˆ° event
>     

é¢è¯•å®˜ä¼šè§‰å¾—ä½ â€œçœŸåšè¿‡â€ï¼Œè€Œä¸æ˜¯èƒŒç­”æ¡ˆã€‚

# ğŸ¯ é¢è¯•æœ€ç»ˆå…¨å±€æ€»ç»“å›ç­”ï¼ˆå¯ä»¥èƒŒï¼‰

> Gas ä¼˜åŒ–çš„æœ¬è´¨æ˜¯å‡å°‘ storageã€å‡å°‘è¿ç®—ã€å‡å°‘å¤–éƒ¨è°ƒç”¨ã€‚
> 
> æœ€æœ‰æ•ˆçš„ä¼˜åŒ–åŒ…æ‹¬ï¼š
> 
> - ä½¿ç”¨ calldataã€memory æ›¿ä»£ storage
>     
> - å‡å°‘ SSTOREï¼šç»“æ„ç´§å‡‘ã€åˆå¹¶å†™æ“ä½œ
>     
> - ä½¿ç”¨ immutable/constant
>     
> - å¾ªç¯ä¸­ä½¿ç”¨ç¼“å­˜å˜é‡å’Œ unchecked
>     
> - æ•°æ®ç»“æ„åš packing
>     
> - æ‰¹å¤„ç†å¤–éƒ¨è°ƒç”¨
>     
> - éå¿…è¦ä¿¡æ¯å†™ event è€Œä¸æ˜¯ storage



## **2ï¸âƒ£ `storage`ã€`memory`ã€`calldata` çš„ Gas æˆæœ¬å·®å¼‚ï¼Ÿ**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**

| ç±»å‹         | æˆæœ¬             | ç‰¹ç‚¹          |
| ---------- | -------------- | ----------- |
| `storage`  | **æœ€è´µ**ï¼ˆè¯»è´µã€å†™æ›´è´µï¼‰ | é“¾ä¸Šæ°¸ä¹…å­˜å‚¨      |
| `memory`   | ä¸­ç­‰             | ä¸´æ—¶å˜é‡        |
| `calldata` | **æœ€ä¾¿å®œ**        | å¤–éƒ¨å‡½æ•°å‚æ•°ï¼Œä¸èƒ½ä¿®æ”¹ |

**é¢è¯•é‡‘å¥ï¼š**

> â€œèƒ½ä¸ç”¨ storage å°±ä¸ç”¨ï¼Œèƒ½ç”¨ calldata å°±ä¸ç”¨ memoryã€‚â€

## **3ï¸âƒ£ å‡å°‘ `storage` è®¿é—®æ€ä¹ˆä¼˜åŒ–ï¼Ÿ**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**  
æŠŠ storage çš„å€¼å…ˆ**è¯»åˆ° memory æˆ– local å˜é‡**é‡Œï¼Œç”¨å®Œå†å†™å›ã€‚  
å› ä¸ºæ¯æ¬¡è¯»å– storage éƒ½å¾ˆè´µã€‚

**ç¤ºä¾‹ï¼š**

`uint x = s.a; // ç¼“å­˜ for(...) {     x += 1; } s.a = x; // æœ€åå†™å›`

## **4ï¸âƒ£ `uint8/uint16` è¿™äº›å°ç±»å‹ä¼šçœ Gas å—ï¼Ÿ**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**

> å¦‚æœå•ç‹¬ä½¿ç”¨ï¼Œä¸çœ Gasï¼›  
> å¦‚æœ**å¤šä¸ªä¸€èµ·å£°æ˜**èƒ½ **æ‰“åŒ…åˆ°åŒä¸€ä¸ª 32 å­—èŠ‚**ï¼Œæ‰çœ Gasã€‚

ä¾‹å¦‚ï¼š

`uint128 a; uint128 b;  // å¯ä»¥æ‰“åŒ…`

æ¯”ï¼š

`uint256 a; uint256 b;`

æ›´ä¾¿å®œã€‚

## **5ï¸âƒ£ `++i` ä¸ `i++` çš„åŒºåˆ«ï¼ˆç»å…¸è€ƒç‚¹ï¼‰**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**

- `i++` è¦æ‹·è´æ—§å€¼ â†’ Gas æ›´è´µ
    
- `++i` ä¸éœ€è¦ â†’ æ›´ä¾¿å®œ
    

**é¢è¯•è¯´ä¸€å¥ï¼š**

> â€œå†™å¾ªç¯ç»Ÿä¸€ç”¨ `++i`ï¼Œè¿™æ˜¯æœ€ç®€å•ç›´æ¥çš„ä¼˜åŒ–ã€‚â€


## **6ï¸âƒ£ å›ºå®šé•¿åº¦æ•°ç»„ vs åŠ¨æ€æ•°ç»„ Gas å¯¹æ¯”**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**

- **å›ºå®šé•¿åº¦æ•°ç»„æ›´çœ gas**ï¼ˆä¸å­˜é•¿åº¦ï¼‰
    
- åŠ¨æ€æ•°ç»„æ¯æ¬¡ push/length éƒ½è¦ storage æ“ä½œ

## **7ï¸âƒ£ `require(errorMsg)` çš„å­—ç¬¦ä¸²é•¿çŸ­å½±å“ Gas å—ï¼Ÿ**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**  
æ˜¯çš„ï¼Œå­—ç¬¦ä¸²è¶Šé•¿ Gas è¶Šè´µï¼Œæ‰€ä»¥ï¼š

> **ç”Ÿäº§ç¯å¢ƒè¦ç”¨çŸ­é”™è¯¯ç ï¼Œä¾‹å¦‚ 'LEN_ERR' ä¼šæ¯” 'Length must be 1' ä¾¿å®œã€‚**


## **8ï¸âƒ£ é¿å…åœ¨å¾ªç¯é‡Œåšä»€ä¹ˆï¼Ÿï¼ˆé«˜é¢‘è€ƒï¼‰**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**  
å¾ªç¯é‡Œä¸è¦ï¼š

- è®¿é—® storage
    
- emit event
    
- è°ƒç”¨å¤–éƒ¨åˆçº¦
    
- åˆ›å»ºæ•°ç»„
    
- push / pop
    

è¶Šå°‘è¶Šå¥½ï¼Œå¦åˆ™ä¼š â€œGas çˆ†ç‚¸â€ã€‚

## **9ï¸âƒ£ `immutable` å’Œ `constant` çš„ä½œç”¨ï¼Ÿ**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**

|ç±»å‹|Gas|æè¿°|
|---|---|---|
|`constant`|æœ€ä¾¿å®œ|ç¼–è¯‘æœŸå†™æ­»åœ¨ bytecode|
|`immutable`|å¾ˆä¾¿å®œ|éƒ¨ç½²æ—¶å†™å…¥ï¼Œåªè¯»ï¼Œä¸å¯æ”¹|

æ¯”æ™®é€š storage **ä¾¿å®œå¾ˆå¤š**ã€‚

## **ğŸ”Ÿ åœ¨ Solidity ä¸­ä½¿ç”¨ `unchecked` å‡å°‘ Gasï¼Ÿ**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**  
åœ¨ç¡®å®šä¸ä¼šæº¢å‡ºçš„æƒ…å†µä¸‹ï¼ŒæŠŠåŠ å‡æ³•æ”¾è¿›ï¼š

`unchecked { i++ }`

èƒ½çœå»æº¢å‡ºæ£€æŸ¥ Gasï¼Œå¾ªç¯é‡Œéå¸¸æœ‰æ•ˆã€‚

## **1ï¸âƒ£1ï¸âƒ£ event ä¸ºä»€ä¹ˆè¦è°¨æ…ä½¿ç”¨ï¼Ÿ**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**  
`event` ä¼šå†™ logï¼Œå±äº**é“¾ä¸‹å­˜å‚¨**ï¼Œä½†ä»ç„¶ **è¦ Gas**ï¼Œè€Œä¸”æŒ‰å­—èŠ‚æ”¶è´¹ã€‚

> â€œèƒ½ä¸ emit å°±ä¸ emitï¼Œæˆ–è€…å°½é‡å‡å°‘å‚æ•°ã€‚â€

## **1ï¸âƒ£2ï¸âƒ£ ABI ç¼–ç æ–¹å¼æ˜¯å¦å½±å“ Gasï¼Ÿ**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**  
æ˜¯çš„ï¼š

- `abi.encodePacked()` æœ€ä¾¿å®œï¼ˆç´§å‡‘ï¼‰
    
- `abi.encode()` æœ€è´µï¼ˆå¸¦é•¿åº¦ã€å¯¹é½ paddingï¼‰
    

å¦‚æœèƒ½ä½¿ç”¨ `encodePacked`ï¼Œå°½é‡ç”¨ã€‚

## **1ï¸âƒ£3ï¸âƒ£ external vs public å¯¹ Gas çš„å½±å“ï¼Ÿ**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**  
`external` çš„å‚æ•°ä½¿ç”¨ calldata â†’ æœ€çœ Gasã€‚  
`public` éœ€è¦æŠŠå‚æ•°å¤åˆ¶åˆ° memory â†’ æ›´è´µã€‚

> â€œèƒ½ç”¨ external å°±ä¸ç”¨ publicã€‚â€

## **1ï¸âƒ£4ï¸âƒ£ revertã€requireã€assert å“ªä¸ªæœ€è´µï¼Ÿ**

**ç­”æ¡ˆï¼ˆèƒŒè¯µç‰ˆï¼‰ï¼š**

- æ­£å¸¸æ‰§è¡Œï¼šæ— å·®åˆ«
    
- è§¦å‘å¼‚å¸¸ï¼š`assert` æœ€è´µ
    

å› ä¸º assert ä¼šæ¶ˆè€—å‰©ä½™ gasã€‚

# ğŸ“š **æ€»ç»“ï¼ˆé¢è¯•å¿«é€ŸèƒŒè¯µç‰ˆï¼‰**

ä½ åªè¦è®°ä½ä»¥ä¸‹é‡‘å¥ï¼š

1. **storage æœ€è´µï¼Œcalldata æœ€ä¾¿å®œã€‚**
    
2. **å¾ªç¯é‡Œä¸è¦è®¿é—® storageã€‚**
    
3. **++i æ¯” i++ çœã€‚**
    
4. **immutable/constant æçœ gasã€‚**
    
5. **å¤šå˜é‡èƒ½æ‰“åŒ…åˆ° 32 å­—èŠ‚å°±æ‰“ã€‚**
    
6. **external æ¯” public çœ gasã€‚**
    
7. **require å­—ç¬¦ä¸²è¶ŠçŸ­è¶Šçœã€‚**
    
8. **èƒ½ unchecked çš„åœ°æ–¹å°± uncheckedã€‚**
    
9. **encodePacked æ¯” encode çœã€‚**
    

é¢è¯•åŸºæœ¬ç¨³ï¼