# 黑马头条实战-Day03

## 实战背景说明：

在此之前我们已经实现了两天的实战内容了，大家基本上已经熟悉了整个项目的架构和技术了，那么今天我们体现的是整个实战中稍微有点难度的功能了，那就是文章发布和审核功能。

难度系数：★★★☆☆

今天实战内容大家可以学习到以下知识：

- 掌握文章发布与审核的流程
- 掌握使用openFegin远程微服务调用
- 学习到第三方百度云审核技术
- 学习到异步线程的使用



## 1、自媒体端-文章发布&审核

### 1.1、任务1：文章发布

#### 1.1.1、需求分析:

![1690186436512](assets/1690186436512.png)

#### 1.1.2、表结构分析

wm_news 自媒体文章表

![1690188254055](assets/1690188254055.png)

wm_material 素材表

![1690188288840](assets/1690188288840.png)

wm_news_material 文章素材关系表

![1690188313849](assets/1690188313849.png)

#### 1.1.3、实现思路分析

该功能为保存、修改（是否有id）、保存草稿的共有方法

![1690188424515](assets/1690188424515.png)

匹配规则：

> 如果封面图片选择是自动的话，则从内容中的图片作为封面图片
>
> 内容中无图 ，则设置为封面是无图结构
>
> 内容中的图片数量大于等于1，小于3，则设置封面为单图
>
> 内容中的图片数量大于等于3，则设置封面为多图

#### 1.1.4、功能实现

![1690191929326](assets/1690191929326.png)

WmNewsDto请求参数

![1690191970891](assets/1690191970891.png)





### 1.2、文章审核

​			根据1.1的文章发布操作来看，最终发布完成之后，文章的状态应该目前是有两个的，第一个是草稿状态，第二个是待审核状态，那么此时这些文章还不能够被C端用户看到，那么只有文章审核通过之后才能让C端用户看到。

#### 1.2.1、数据流转图

![1690192522123](assets/1690192522123.png)

审核方式有两种：

- 机器自动审核
  - 系统自动审核，主要是通过第三方接口对文章内容进行审核（成功、失败、不确定）。
- 人工审核
  - 当机审返回的审核结果为不确定的时候，才会执行人工审核

#### 1.2.2、机审自动审核流程思路分析

![1690192644999](assets/1690192644999.png)

#### 1.2.3、任务2：学习百度云审核

​		内容安全是识别服务，支持对图片、视频、文本、语音等对象进行多样化场景检测，有效降低内容违规风险。

​		目前很多平台都支持内容检测，如阿里云、腾讯云、百度AI、网易云等国内大型互联网公司都对外提供了API。

按照性能和收费来看，黑马头条项目使用的就是阿里云或者百度云的内容安全接口，使用到了图片和文本的审核。

百度云内容审核产品介绍：https://cloud.baidu.com/solution/censoring

百度云内容审核接口文档：https://cloud.baidu.com/doc/ANTIPORN/s/Nk3h6xbb2

![1690193137781](assets/1690193137781.png)

1，前往[百度云官网](https://cloud.baidu.com/)注册账号并完成实名认证

2，打开控制台：[https://console.bce.baidu.com/ai/#/ai/antiporn/overview/index](https://console.bce.baidu.com/ai/) 按照操作指引的第1步和第2步操作 

![1690193200837](assets/1690193200837.png)

**测试在线文本审核和图片审核**

![1690193356088](assets/1690193356088.png)





#### 1.2.4、任务3：完成文章微服务保存功能

##### 1.2.4.1、表结构分析

![1690193470230](assets/1690193470230.png)

##### 1.2.4.2、实现思路分析

![1690193503088](assets/1690193503088.png)

##### 1.2.4.3、功能实现

![1690193648273](assets/1690193648273.png)

**提示：**

此接口写完之后，还需要给该接口编写一个Fegin接口来调用该接口，应该该接口是要被文章审核远程调用的。





#### 1.2.4、任务4：完成自动审核业务功能

在wemedia微服务中定义一个自动审核的接口，然后在接口实现类中完成业务实现：

**实现提示：**

- 非空判断
- 根据文章id查询自媒体实体对象，如果为空，则直接返回
- 抽取所有的文本和图片
- 文本审核
- 图片审核
- 审核通过，远程调用app端新增article表的接口
- 修改wmNews表的状态为9



### 1.3、任务5：文章发布与审核集成

**流程图分析**

![1690198728918](assets/1690198728918.png)

**思路提示：**

​		发布文章与文章审核，是两个独立的方法，两者方法都在同一个微服务中，那么调用应该用异步调用，为什么不用同步调用呢，因为这两个方法不应该互相影响，如果审核不成功，不能影响发布，最多发布文章的状态是属于待审核状态。所以呢，此时调用建议用异步调用

而异步调用，不是建议采用RabbitMq，建议使用异步线程使用。



> 1、SpringBoot使用异步线程方法：
>
> ①：在自动审核的方法上加上@Async注解（标明要异步调用）
>
> ②：在文章发布成功后调用审核的方法
>
> ③：在自媒体引导类中使用@EnableAsync注解开启异步调用
>
> 2、采用线程池方式：
>
>    根据阿里规范，建议大家采用线程池方式，不要采用异步线程，为什么？
>
> 因为，异步线程是属于野线程

目标作业：学习线程池的知识，并且利用线程池改造文章发布调用文章审核业务。



## 2、面试问题

面试官问题：

- 文章表中的状态都有哪些？
- 文章发布与审核的关系是什么？以及文章审核是采用什么样的方式审核的
- 什么情况下才会进行人工审核？
- OpenFeign远程调用是基于什么协议调用的？以及OpenFegin实现远程调用的原理是什么？

