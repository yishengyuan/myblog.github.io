# âœ… ä¸€ã€æ­»é”æ˜¯å¦‚ä½•äº§ç”Ÿçš„ï¼ˆå››ä¸ªå¿…è¦æ¡ä»¶ï¼‰

æ­»é”äº§ç”Ÿå¿…é¡»åŒæ—¶æ»¡è¶³ä»¥ä¸‹å››ä¸ªæ¡ä»¶ï¼Œç¼ºä¸€ä¸å¯ï¼š

### **1. äº’æ–¥æ¡ä»¶ï¼ˆMutual Exclusionï¼‰**

èµ„æºä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å æœ‰ã€‚

### **2. è¯·æ±‚å’Œä¿æŒï¼ˆHold and Waitï¼‰**

çº¿ç¨‹å·²ç»æŒæœ‰èµ„æº Aï¼ŒåŒæ—¶å†è¯·æ±‚èµ„æº Bï¼Œä½†è¢«é˜»å¡ä¸”ä¸é‡Šæ”¾ Aã€‚

### **3. ä¸å¯å‰¥å¤ºï¼ˆNo Preemptionï¼‰**

çº¿ç¨‹è·å–çš„èµ„æºåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½è¢«æŠ¢å ï¼Œåªèƒ½ä¸»åŠ¨é‡Šæ”¾ã€‚

### **4. å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼ˆCircular Waitï¼‰**

å­˜åœ¨ä¸€ä¸ªå¾ªç¯èµ„æºç­‰å¾…é“¾ï¼Œæ¯”å¦‚ï¼š

`T1 æŒæœ‰é” Aï¼Œç­‰å¾…é” B T2 æŒæœ‰é” Bï¼Œç­‰å¾…é” A`

â¡ï¸ **è¿™å››ä¸ªæ¡ä»¶åŒæ—¶æˆç«‹ï¼Œæ­»é”å¿…å‡ºç°ã€‚**


# âœ… äºŒã€æ­»é”æ¡ˆåˆ—ä¸¾ä¾‹ï¼ˆç»å…¸ï¼‰

### **ç¤ºä¾‹ï¼šä¸¤ä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹çš„é”**

```
Object lockA = new Object();
Object lockB = new Object();

Thread t1 = new Thread(() -> {
    synchronized (lockA) {
        System.out.println("t1 æ‹¿åˆ° A");
        try { Thread.sleep(100); } catch (Exception e) {}
        synchronized (lockB) {
            System.out.println("t1 æ‹¿åˆ° B");
        }
    }
});

Thread t2 = new Thread(() -> {
    synchronized (lockB) {
        System.out.println("t2 æ‹¿åˆ° B");
        try { Thread.sleep(100); } catch (Exception e) {}
        synchronized (lockA) {
            System.out.println("t2 æ‹¿åˆ° A");
        }
    }
});

```

â¡ï¸ **çº¿ç¨‹ 1 ï¼šé” A â†’ ç­‰ B**  
â¡ï¸ **çº¿ç¨‹ 2 ï¼šé” B â†’ ç­‰ A**  
å¾ªç¯ç­‰å¾…äº§ç”Ÿæ­»é”ã€‚
# âœ… ä¸‰ã€æ­»é”è§£å†³æ–¹æ¡ˆï¼ˆé¢è¯•å¸¸é—®ï¼‰

## â­ï¼ˆ1ï¼‰ç ´åå¾ªç¯ç­‰å¾… â€”â€” å°½é‡**å›ºå®šåŠ é”é¡ºåº**

ä¾‹å¦‚ï¼šæ‰€æœ‰çº¿ç¨‹æŒ‰ç…§ `èµ„æº ID ä»å°åˆ°å¤§` çš„é¡ºåºåŠ é”ã€‚

`// å¿…é¡»å…ˆé” A å†é” B`

åªè¦ä¿è¯åŠ é”é¡ºåºä¸€è‡´ï¼Œå°±ä¸ä¼šå‡ºç° Aâ†’B åŒæ—¶ Bâ†’A çš„å¾ªç¯ç­‰å¾…ã€‚

â¡ï¸ **æœ€å¸¸ç”¨ã€æœ€æœ‰æ•ˆã€æœ€å®¹æ˜“é¢è¯•è¯´**ã€‚

---

## â­ï¼ˆ2ï¼‰ä½¿ç”¨ tryLock + è¶…æ—¶æœºåˆ¶ï¼ˆé¿å…æ— é™ç­‰å¾…ï¼‰

ä½¿ç”¨ `ReentrantLock.tryLock(timeout)`ï¼š
```
if (lockA.tryLock(1, TimeUnit.SECONDS)) {
    try {
        if (lockB.tryLock(1, TimeUnit.SECONDS)) {
            try {
                // ...
            } finally {
                lockB.unlock();
            }
        }
    } finally {
        lockA.unlock();
    }
}

```
â¡ï¸ ç­‰ä¸åˆ°å°±ç›´æ¥æ”¾å¼ƒï¼Œä¸ä¼šå‡ºç°æ­»é”ã€‚

---

## â­ï¼ˆ3ï¼‰å‡å°‘é”ç²’åº¦ / ä½¿ç”¨æ›´é«˜å±‚çº§çš„å¹¶å‘ç»“æ„

ä¾‹å¦‚ï¼š

- ä½¿ç”¨ `ConcurrentHashMap` æ›¿ä»£ synchronized + HashMap
    
- ä½¿ç”¨ `Atomic` åŸå­ç±»
    
- ä½¿ç”¨ `ReadWriteLock`
    
- ä½¿ç”¨ `StampedLock`
    

â¡ï¸ **å‡å°‘ä¸å¿…è¦çš„é”ç«äº‰ï¼Œè‡ªç„¶é™ä½æ­»é”æ¦‚ç‡ã€‚**

---

## â­ï¼ˆ4ï¼‰é¿å…åµŒå¥—åŠ é”

æ¯”å¦‚ï¼š

`synchronized(A) {     synchronized(B) {         ...     } }`

é¢è¯•å®˜æœ€å–œæ¬¢é—®ï¼š**å¦‚ä½•é¿å…ï¼Ÿ**  
ç­”ï¼š

- å°½é‡å‡å°‘åµŒå¥—åŠ é”
    
- å°†é”æ‹†åˆ†
    
- åˆå¹¶ä¸šåŠ¡é€»è¾‘ï¼Œå‡å°‘ä¸´ç•ŒåŒº
    

---

## â­ï¼ˆ5ï¼‰ä½¿ç”¨æ­»é”æ£€æµ‹å·¥å…·ï¼ˆç”Ÿäº§ä¸­å¯è¡Œï¼‰

å¦‚ï¼š

- **jstack**
    
- **Java VisualVM**
    
- **Arthas**
    

å¦‚æœçº¿ç¨‹å‡ºç° `deadlock`ï¼Œå·¥å…·ä¼šç›´æ¥æŒ‡å‡ºæ¶‰åŠå“ªäº›é”

# âœ… ä¸€ã€jstack æ’æŸ¥æ­»é” â€”â€” æœ€å¸¸ç”¨ã€æœ€å¿«é€Ÿ

### **æ­¥éª¤ 1ï¼šæ‰¾åˆ° Java è¿›ç¨‹ PID**

Linuxï¼š

`jps -l`

Windowsï¼š

`jps -l`

æˆ–è€…ç³»ç»Ÿå·¥å…·ï¼š`ps -ef | grep java`

å‡è®¾ PID = 12345

---

### **æ­¥éª¤ 2ï¼šä½¿ç”¨ jstack è¾“å‡ºçº¿ç¨‹å¿«ç…§**

`jstack -l 12345 > threadDump.log`

ç”Ÿæˆ `threadDump.log` æ–‡ä»¶ï¼ˆåœ¨å½“å‰ç›®å½•ï¼‰ã€‚

---

### **æ­¥éª¤ 3ï¼šæœç´¢ deadlock å…³é”®å­—**

æ‰“å¼€ `threadDump.log`ï¼Œæœç´¢ï¼š

`Found one Java-level deadlock:`

å¦‚æœå‡ºç°ï¼Œä¸‹é¢ä¼šåˆ—å‡ºï¼š

- å“ªå‡ ä¸ªçº¿ç¨‹æ­»é”
    
- å¡åœ¨å“ªè¡Œä»£ç 
    
- æŒæœ‰å“ªäº›é”
    
- ç­‰å¾…å“ªäº›é”
    

ç¤ºä¾‹ï¼š

`Java-level deadlock: "Thread-1": waiting to lock <0x00000000d5b8a4f8> (object A), held by "Thread-2" "Thread-2": waiting to lock <0x00000000d5b8a518> (object B), held by "Thread-1"`

â¡ï¸ **éå¸¸æ˜ç¡®åœ°å‘Šè¯‰ä½ æ­»é”ä½ç½®ã€‚**

### **æ­¥éª¤ 4ï¼šå®šä½ä½ çš„ä»£ç çš„è¡Œå·**

ç»§ç»­å¾€ä¸‹æ‰¾ `"locked"` å’Œ `"waiting to lock"`ï¼š

`at com.xx.Test.methodA(Test.java:45)`

â¡ï¸ ç›´æ¥è·³åˆ°ä½ ä»£ç ä¸­å‘ç”Ÿæ­»é”çš„è¡Œã€‚

---

# âœ… äºŒã€Java VisualVM å›¾å½¢åŒ–æ’æŸ¥æ­»é”

VisualVM çœ‹å¾—æœ€æ¸…æ™°ã€æœ€ç›´è§‚ï¼Œé€‚åˆç”Ÿäº§å¿«é€Ÿå®šä½ã€‚

---

### **æ­¥éª¤ 1ï¼šæ‰“å¼€ VisualVM**

JDK è‡ªå¸¦ï¼š  
Windows / Linux è·¯å¾„ï¼š

`/bin/jvisualvm`

---

### **æ­¥éª¤ 2ï¼šè¿æ¥åˆ°ç›®æ ‡ Java è¿›ç¨‹**

åœ¨å·¦è¾¹åˆ—è¡¨ä¸­æ‰¾åˆ°ä½ çš„ Java ç¨‹åºï¼š

`Local    â””â”€  JavaApplication (12345)`

åŒå‡»æ‰“å¼€ã€‚

---

### **æ­¥éª¤ 3ï¼šæŸ¥çœ‹çº¿ç¨‹ï¼ˆThreadsï¼‰**

ç‚¹å‡» TABï¼š`Threads`

ä½ å¯ä»¥çœ‹åˆ°ï¼š

- æ¯ä¸ªçº¿ç¨‹å †æ ˆ
    
- å“ªäº›çº¿ç¨‹ Blocked / Waiting
    
- çº¿ç¨‹è°ƒç”¨è·¯å¾„
    
- CPU ä½¿ç”¨æƒ…å†µ
    

---

### **æ­¥éª¤ 4ï¼šè‡ªåŠ¨è¯†åˆ«æ­»é”**

VisualVM ä¼šè‡ªåŠ¨æ£€æµ‹æ­»é”ï¼Œå‡ºç°çº¢è‰²æç¤ºï¼š

`Deadlock detected`

ç‚¹å‡»å³å¯çœ‹åˆ°æ­»é”è¯¦æƒ…ï¼ŒåŒ…æ‹¬ï¼š

- å“ªä¸¤ä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…
    
- å“ªä¸ªå¯¹è±¡ç›‘è§†å™¨å¯¼è‡´æ­»é”
    
- å¯¹åº” Java ä»£ç ä½ç½®
    

â¡ï¸ å¯è§†åŒ–æ•ˆæœå’Œ jstack ä¸€æ¨¡ä¸€æ ·ï¼Œä½†æ›´å‹å¥½ã€‚

---

# âœ… ä¸‰ã€Arthas æ’æŸ¥æ­»é”ï¼ˆé˜¿é‡Œå¼€æºï¼‰

Arthas ä¼˜ç‚¹ï¼š

- ä¸éœ€è¦é‡å¯è¿›ç¨‹
    
- åŠ¨æ€ attach
    
- åœ¨çº¿åˆ†æçº¿ç¨‹çŠ¶æ€
    
- æ›´é€‚åˆçº¿ä¸Šæ’æŸ¥
    

---

## âœ” æ­¥éª¤ 1ï¼šå¯åŠ¨ Arthas

`java -jar arthas-boot.jar`

å®ƒä¼šæ‰«æå½“å‰ JVM è¿›ç¨‹ï¼Œç„¶åè®©ä½ é€‰è¦ attach çš„ PIDã€‚

è¾“å…¥å¯¹åº”çš„æ•°å­—å³å¯ã€‚

---

## âœ” æ­¥éª¤ 2ï¼šä½¿ç”¨ thread å‘½ä»¤æŸ¥çœ‹æ­»é”

Arthas ä¸­æ‰§è¡Œï¼š

`thread -b`

`-b` è¡¨ç¤ºé˜»å¡ï¼ˆblockedï¼‰çº¿ç¨‹ä¿¡æ¯ã€‚

å¦‚æœæœ‰æ­»é”ï¼Œä¼šè‡ªåŠ¨æ˜¾ç¤ºï¼š

`Deadlock found :     threadId=29 threadName="Thread-1"     waiting to lock <0x00000000d5b8a4f8>, held by threadId=30  Deadlock found :     threadId=30 threadName="Thread-2"     waiting to lock <0x00000000d5b8a518>, held by threadId=29`

â¡ï¸ ä¿¡æ¯å’Œ jstack ä¸€æ ·ï¼Œä½†æ›´å®æ—¶ã€‚

---

## âœ” æ­¥éª¤ 3ï¼šæŸ¥çœ‹å®Œæ•´çº¿ç¨‹å †æ ˆ

`thread 29`

æˆ–ï¼š

`thread 30`

æ˜¾ç¤ºå®Œæ•´å †æ ˆï¼š

`at com.xx.Test.methodA(Test.java:45)`

ç›´æ¥å‘Šè¯‰ä½ æ­»é”å‘ç”Ÿåœ¨ä½ é¡¹ç›®ä¸­çš„å“ªä¸€è¡Œä»£ç ã€‚

---

# ğŸ¯ å››ã€æ€»ç»“ï¼ˆé¢è¯•å¯èƒŒè¯µï¼‰

### **jstackï¼š**

- jps æŸ¥ PID
    
- jstack -l è¾“å‡ºçº¿ç¨‹ dump
    
- æœç´¢ `deadlock` å¹¶å®šä½ä»£ç è¡Œå·
    

### **VisualVMï¼š**

- å›¾å½¢åŒ–
    
- Threads é¢æ¿è‡ªåŠ¨æ£€æµ‹æ­»é”
    
- æ˜¾ç¤ºçº¿ç¨‹ã€é”ã€è°ƒç”¨è·¯å¾„
    

### **Arthasï¼š**

- thread -b æŸ¥çœ‹æ­»é”
    
- thread threadId çœ‹å †æ ˆ
    
- åœ¨çº¿æ’æŸ¥ä¸ç”¨åœæœº