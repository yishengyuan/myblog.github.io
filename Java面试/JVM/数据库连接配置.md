# âœ… çº¿ä¸Šæ•°æ®åº“è¿æ¥æ± åº”è¯¥æ€ä¹ˆé…ç½®ï¼Ÿ

ä»¥ **Druid / HikariCP** ä¸ºä¾‹ï¼Œä¸¤è€…æ€è·¯å®Œå…¨ç›¸åŒï¼Œæˆ‘ç”¨ HikariCP ä¸¾ä¾‹ã€‚

---

# ğŸ“Œ ä¸€ã€æ ¸å¿ƒç›®æ ‡

çº¿ä¸Šæ•°æ®åº“è¿æ¥æ± çš„å‚æ•°é…ç½®ä¸»è¦ä¸ºäº†è§£å†³ä¸‰ä¸ªé—®é¢˜ï¼š

1. **é¿å…è¿æ¥ä¸å¤Ÿ â†’ çº¿ç¨‹æ’é˜Ÿã€æ¥å£è¶…æ—¶**
    
2. **é¿å…è¿æ¥è¿‡å¤š â†’ æ•°æ®åº“å‹åŠ›è¿‡å¤§**
    
3. **ä¿è¯è¿æ¥ç¨³å®šå­˜æ´»ï¼Œä¸æŠ¥é”™ï¼ˆè¿æ¥æ–­å¼€ã€idle timeout ç­‰é—®é¢˜ï¼‰**
    

---

# ğŸ“Œ äºŒã€ç”Ÿäº§ç¯å¢ƒæ¨èå‚æ•°ï¼ˆHikariCPä¸ºä¾‹ï¼‰

## 1ï¼‰**maximumPoolSizeï¼ˆæœ€å¤§è¿æ¥æ•°ï¼‰**

ä¸€èˆ¬æ ¹æ®ç»éªŒæˆ–å…¬å¼ï¼š

### âœ” æ¨èå…¬å¼

`æœ€å¤§è¿æ¥æ•° = CPU æ ¸æ•° * 2 + æœ‰æ•ˆè´Ÿè½½`

ä½†æ›´å®é™…çš„æ˜¯ï¼š**ä¸è¦è¶…è¿‡æ•°æ®åº“æœ€å¤§è¿æ¥æ•°çš„ 1/4ï½1/3**  
ä¾‹å¦‚æ•°æ®åº“ max_connections=400ï¼Œä½ çš„æœåŠ¡æœ€å¤šé… **80â€“120**ã€‚

### å®é™…æ¨èèŒƒå›´

- å°æµé‡ï¼š10â€“20
    
- ä¸­ç­‰å‹åŠ›ï¼š30â€“50
    
- é«˜å¹¶å‘æ ¸å¿ƒæœåŠ¡ï¼š50â€“100
    

---

## 2ï¼‰**minimumIdleï¼ˆæœ€å°ç©ºé—²è¿æ¥ï¼‰**

æ¨èè®¾ç½®ä¸ºï¼š

`minimumIdle = maximumPoolSize çš„ 30%~50%`

ä¿è¯ä¸šåŠ¡é«˜å³°æ—¶ä¸éœ€è¦é¢‘ç¹å»ºç«‹è¿æ¥ï¼ˆè¿æ¥å»ºç«‹æˆæœ¬é«˜ï¼‰ã€‚

---

## 3ï¼‰**connectionTimeoutï¼ˆè·å–è¿æ¥è¶…æ—¶æ—¶é—´ï¼‰**

ä¸€èˆ¬ï¼š**500ms â€“ 3000ms**  
ä¸è¦è®¾ç½®å¤ªé«˜ï¼Œå¦åˆ™çº¿ç¨‹å †ç§¯å¯¼è‡´é›ªå´©ã€‚

æ¨èï¼š**1000msï¼ˆ1ç§’ï¼‰**

---

## 4ï¼‰**idleTimeoutï¼ˆç©ºé—²è¿æ¥ä¿ç•™æ—¶é—´ï¼‰**

æ¨èï¼š**10~30 ç§’**

è¿æ¥å¤ªä¹…ä¸ç”¨å¯èƒ½è¢«æ•°æ®åº“é˜²ç«å¢™è¸¢æ‰ã€‚

---

## 5ï¼‰**maxLifetimeï¼ˆè¿æ¥æœ€å¤§å­˜æ´»æ—¶é—´ï¼‰**

éå¸¸å…³é”®ï¼Œç”¨é”™ä¼šå¯¼è‡´å¤§é‡è¿æ¥è¢«è¸¢ä¸‹çº¿ã€‚

æ¨èï¼š**ä¸è¦è¶…è¿‡æ•°æ®åº“çš„ wait_timeoutï¼Œæå‰30ç§’æ–­å¼€**

ä¾‹å¦‚ MySQL é»˜è®¤ï¼š

`wait_timeout = 28800 ç§’ï¼ˆ8å°æ—¶ï¼‰`

å»ºè®®è®¾ç½®ï¼š

`maxLifetime = 28700 ç§’ï¼ˆæ¯”æ•°æ®åº“è¶…æ—¶ç•¥å°ï¼‰`

é¿å…è¿æ¥è¢« MySQL å…ˆæ–­å¼€å¯¼è‡´ â€œConnection resetâ€ é”™è¯¯ã€‚

---

## 6ï¼‰**connectionTestQuery / keepalive**

ä¸ºäº†é¿å…ç©ºé—²è¿æ¥æ–­å¼€ï¼š

Hikari å»ºè®®ï¼š

`keepaliveTime = 300000msï¼ˆ5åˆ†é’Ÿï¼‰`

æˆ–è€…ä½¿ç”¨ï¼š

`connectionTestQuery = SELECT 1`

---

# ğŸ“Œ ä¸‰ã€HikariCP æ¨èç”Ÿäº§é…ç½®ç¤ºä¾‹

`spring.datasource.hikari:   maximum-pool-size: 50   minimum-idle: 20   connection-timeout: 2000   idle-timeout: 30000   max-lifetime: 28700000   keepalive-time: 300000`

---

# ğŸ“Œ å››ã€Druid ç”Ÿäº§é…ç½®ï¼ˆå¦‚æœä½ ç”¨ Druidï¼‰

`initialSize: 5 minIdle: 20 maxActive: 50 maxWait: 2000 timeBetweenEvictionRunsMillis: 60000 minEvictableIdleTimeMillis: 300000 validationQuery: SELECT 1 testWhileIdle: true testOnBorrow: false testOnReturn: false`

---

# ğŸ“Œ äº”ã€æ•°æ®åº“é™æµä¸ä¿æŠ¤ï¼ˆæœ€é‡è¦çš„éƒ¨åˆ†ï¼‰

çº¿ä¸Šå®¹æ˜“è¢«å¿½ç•¥çš„éƒ¨åˆ†ï¼š  
**æ•°æ®åº“ä¸æ˜¯æ— é™æ‰¿è½½ï¼Œè¦é˜²æ­¢è¢«æ‰“çˆ†ã€‚**

ç”Ÿäº§å»ºè®®ï¼š

### âœ” åº”ç”¨ä¾§è¿æ¥æ± é™åˆ¶ï¼ˆå¦‚ max 50ï¼‰

### âœ” ä½¿ç”¨ Hystrix/Resilience4j çº¿ç¨‹éš”ç¦»

### âœ” SQL è¶…æ—¶æ—¶é—´é™åˆ¶ï¼ˆä¾‹å¦‚ 3 ç§’ï¼‰

### âœ” å¤§æŸ¥è¯¢åˆ†é¡µé™åˆ¶

### âœ” æ…¢ SQL å‘Šè­¦

---

# ğŸ“Œ å…­ã€é¢è¯•å¯ä»¥è¿™æ ·æ€»ç»“ï¼ˆéå¸¸åŠ åˆ†ï¼‰

> çº¿ä¸Šæ•°æ®åº“è¿æ¥å‚æ•°çš„é…ç½®æ ¸å¿ƒæ˜¯å¹³è¡¡â€œååâ€å’Œâ€œæ•°æ®åº“å‹åŠ›â€ã€‚  
> æˆ‘ä»¬ä¸€èˆ¬æ ¹æ®æœåŠ¡å™¨æ ¸æ•°å’Œæ•°æ®åº“æœ€å¤§è¿æ¥æ•°æ¥è®¾ç½® maximumPoolSizeï¼Œé¿å…è¿‡å¤§å‹å®æ•°æ®åº“ï¼›minimumIdle ä¿è¯é«˜å³°ä¸é¢‘ç¹å»ºè¿æ¥ï¼›connectionTimeout æ§åˆ¶è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼›maxLifetime è¦å°äºæ•°æ®åº“ wait_timeoutï¼Œé¿å…å›  MySQL è¢«åŠ¨æ–­å¼€å¯¼è‡´è¿æ¥ä¸å¯ç”¨ã€‚  
> å¦å¤–ä¼šç»“åˆç›‘æ§ï¼ˆGrafanaã€Prometheusï¼‰åŠ¨æ€è°ƒæ•´ã€‚