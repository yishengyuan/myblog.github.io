# ✅ **宕机情况下的数据容错策略**

可以从 **撮合引擎 / 清算服务 / 数据持久化** 三层分析：

---

## 1️⃣ **撮合引擎宕机容错**

### **问题**

- 撮合是强顺序、低延迟的内存状态机
    
- 宕机可能导致 orderbook 丢失或订单未撮合
    

### **解决方案**

1. **交易日志 + 消息队列回放**
    
    - 每次订单事件（下单、撤单、成交）写入 **持久化日志** 或 **Redis Stream / Kafka**
        
    - 撮合重启时，通过 **日志回放** 恢复内存状态
        
2. **快照机制**
    
    - 定期将 orderbook、成交快照写磁盘
        
    - 宕机恢复时，先加载快照，再回放日志
        
3. **高可用主备**
    
    - 热备或双活架构
        
    - 主撮合宕机 → 备节点秒级接管
        
    - 保证热点交易对不丢单
        

> 核心思想：**内存 + 日志 + 快照 → 保证顺序和状态可恢复**

---

## 2️⃣ **清算服务宕机容错**

### **问题**

- 清算涉及用户资金，强一致性要求极高
    
- 宕机可能导致爆仓、风控计算未完成
    

### **解决方案**

1. **内存清算 + 异步落库**
    
    - 内存状态异常 → 从 **撮合事件日志** 重建状态
        
2. **消息队列可靠投递**
    
    - 成交事件、清算事件通过 **消息队列（Kafka/Redis Stream）** 异步发送
        
    - 宕机期间消息积压，恢复后重放
        
3. **幂等操作**
    
    - 落库、清算逻辑支持 **幂等**，防止重放重复扣款或爆仓
        

> 核心思想：**保证数据最终一致 + 幂等 + 消息可靠回放**

---

## 3️⃣ **数据库与持久化容错**

### **问题**

- 宕机可能导致未落库数据丢失
    
- 高频交易压力下数据库成为瓶颈
    

### **解决方案**

1. **异步批量落库**
    
    - 撮合和清算只做内存操作 → 批量异步写入
        
2. **分库分表 + 冷热数据分离**
    
    - 避免热点表宕机影响全局
        
3. **备份与主从同步**
    
    - MySQL/MariaDB 主从同步
        
    - PostgreSQL/WAL 归档
        
    - 定期全量快照
        
4. **消息队列持久化**
    
    - 即使数据库宕机，消息队列可存储未落库事件，恢复后继续处理
        

---

## 4️⃣ **容灾恢复总结**

|层级|宕机容错策略|
|---|---|
|撮合引擎|快照 + 日志回放 + 热备/双活|
|清算服务|内存状态 + 消息队列 + 幂等重放|
|数据库|分库分表 + 异步批量落库 + 主从备份 + 消息队列|
|推送服务|消息队列 + 增量/重试推送|

**关键点总结：**

> 宕机容错核心思想是：**“内存 + 日志 + 快照 + 异步落库 + 幂等重放”**，保证即使主服务宕机，也能恢复用户资金、订单状态和撮合顺序，同时不丢单、不重复执行。