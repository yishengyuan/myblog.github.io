# ✅ **清算服务：内存清算 vs 数据库清算**

交易所清算服务本质是 **资产账户状态更新 + 强一致性结算**，需要考虑 **延迟、吞吐量、可靠性**。

## 1️⃣ **内存清算（Memory-based Clearing）**

### **特点：**

- **高性能**：直接操作内存，毫秒级或微秒级响应
    
- **低延迟**：非常适合高频交易场景
    
- **适合场景**：
    
    - 期货或永续合约标的的保证金计算
        
    - 实时风控和强平（爆仓）判断
        
- **典型做法**：
    
    - 用户资金状态、持仓、风险指标都保存在 **撮合服务或清算服务内存**
        
    - 清算逻辑完成后，将 **变更异步写入数据库** 或通过 **消息队列** 更新持久化账本
        

### **优点：**

- 毫秒级清算，支持高频爆仓
    
- 不受数据库 IO 影响
    

### **风险/瓶颈：**

- 容灾难度高，节点挂掉需依赖日志或快照恢复
    
- 内存状态丢失 → 需依赖 **交易日志回放** 或 **消息队列重放**
## 2️⃣ **数据库清算（DB-based Clearing）**

### **特点：**

- **直接操作数据库**进行清算
    
- 每一笔清算都有 **强一致性保证**
    
- 适合场景：
    
    - 持仓统计、日报清算、账本核对、资金迁移
        
- **典型做法**：
    
    - 撮合完成后，逐条写入 DB 并通过事务保证一致性
        
    - 适合低频、容错性要求高的场景
        

### **优点：**

- 数据可靠，不怕节点宕机
    
- 容易追溯账务、审计
    

### **缺点：**

- 写入 DB 成本高，延迟较大
    
- 不适合高频强平或瞬时风险计算
## 3️⃣ **实际交易所做法（混合方案）**

> 绝大多数交易所采用 **内存清算 + 异步落库** 的方式

### **流程示例：**

1. **撮合引擎输出成交或挂单事件 → 内存清算服务**
    
    - 更新用户余额、仓位、风险指标
        
    - 实时判断是否爆仓
        
2. **异步写数据库/消息队列**
    
    - 保存成交账本、流水、清算记录
        
3. **定期快照 / 日志回放**
    
    - 防止内存状态丢失
        
    - 支撑容灾与审计
        

### **优势：**

- **毫秒级清算 + 高并发处理**
    
- 保证数据最终一致性
    
- 可容错，可回放
    

---

## 4️⃣ **总结回答模板（面试官喜欢听）**

> 我们的清算服务通常是 **基于内存清算 + 异步数据库落库**：  
> 内存清算保证 **毫秒级风控和爆仓处理**，异步落库保证 **账务可靠性**。  
> 同时结合 **快照和日志回放**，既保证性能，又保证可恢复性和审计合规性。  
> 这种模式是交易所处理高频、高并发订单和爆仓的标准实践。