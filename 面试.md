我叫 **Thomas**，从事 **Java Web开发十多年**，主要技术栈包括 **Java、Spring Cloud、Kafka，websocket，Nacos、MySQL**，具备丰富的服务端开发与系统架构经验。

最近参与的项目是 *交易所现货撮合系统**，开发团队规模约 **60+人**，我担任 **Java高级开发工程师**。在任期内，我负责撮合与交易对扩展相关的核心模块开发，在一年内推动平台交易币对从**数增长至50+新增对**，系统日交易额从**约100万提升至200万+**。

主要工作内容包括：

- 新增交易币对及相关撮合逻辑开发与性能优化
    
- 参与架构方案设计及需求评审，评估开发周期
    
- 参与Code Review，优化核心逻辑与服务性能
    
- 线上服务监控运维，排查异常日志，处理生产问题
    
- 跟进迭代版本上线，持续改进交易撮合稳定性和吞吐能力


### **步骤一：网关服务（Gateway）**

用户下单后首先进入网关。  
网关根据 **Symbol（交易对）进行路由分发**，将不同交易对映射到指定的委托交易服务实例，确保**热点交易对固定落在同一节点**，提升吞吐与数据局部性。

---

### **步骤二：委托交易服务（Order Service）**

进行订单入场验证与资金冻结流程：

- 校验委托参数、风控限额、盘口深度、用户状态（封禁/限频）
    
- 校验钱包余额并进行资金冻结，加入幂等校验防重复扣款
    
- 订单持久化入 MySQL
    
- 将委托单 **按 Symbol 作为 Kafka Key** 投递至订单通道，确保同一交易对的消息顺序可控
    

---

### **步骤三：撮合引擎（Matching Engine）**

高性能内存撮合架构：

- Consumer 拉取 Kafka 委托消息 → 批量写入 **Disruptor RingBuffer（2^20+槽位）**
    
- 单线程事件驱动，极低延迟
    
- **限价单结构：TreeMap<Long, MergeOrder>（价格排序）**
    
- **市价单结构：LinkedList<MergeOrder>（双向队列）**

- 撮合逻辑：
    
    - 限价撮合限价
        
    - 市价按最优限价吃单
        
- 成交后更新 OrderBook → **WAL 先追加再虚拟快照**
    
- 达阈值生成 Snapshot → 异步写入 RocksDB（无阻塞） 提交kafka  offset
    
- 成交结果推送 Kafka，**Key = accountId 保证单账户事件有序性 防止死锁 **
    
- 故障恢复：
    
    1. 读取最新 RocksDB Snapshot
        
    2. 获取快照 offset
        
    3. Replay WAL(offset+1 → 末尾)  
        完整恢复订单簿状态
        


## 步骤四：清结算服务（Settlement

消费撮合产出的成交事件：

- 扣减买卖双方资产
    
- Token 转账与资金结算

生成账变记录
手动提交offset
    
- 将结果再写入 Kafka，Topic 按 **symbol+price** 分类投递
    
- 作为后续资金、风险、异步通知的依据


###步骤五：行情服务（Market Data

订阅清结算输出的 Topic：

- 聚合成交&盘口快照
    
- 推送行情数据至 WebSocket
    
- 可根据用户在线量水平水平横向扩容 WebSocket 节点

深度 OrderBook sortedSet
ticker 最新成交价 hash
k线缓存使用sortedset

**因为深度需要按价格实时排序，Sorted Set 天然支持。****Hash 不支持排序，客户端需要自己排序，性能差。**


redis与DB一致性 
撮合完成后，先写 Kafka，再异步写 Redis；如果 Redis 写失败并不会影响订单状态。
事务还是以DB为准 redis只是缓冲 
延迟双删 确保一致性 

金额使用乐观锁 不适用悲观锁或者redis分布式锁 

余额更新**先更新余额表 → 再更新冻结表 → 再写订单表 → 最后落日志表**防止锁表 

MySQL 行级锁死锁，原因是不同服务更新同一行顺序不一致，我们统一了所有资金相关 UPDATE 的顺序后解决。


自增ID：
**订单 ID = 业务前缀 + 机器 ID + 毫秒时间戳 + 自增序列**

统计：
# 构建“汇总统计表 / 冗余表”避免 JOIN
**用空间换时间，冗余字段 / 冗余表，避免 JOIN**

最终一致性：
① **Outbox + 本地事务**：强一致写库，最终一致下游（最常用）。  
② **幂等 + version 乐观锁**：各系统本地事务，通过消息保证最终一致。  
③ **TCC**：只在钱包、提现等强一致跨系统场景使用。




