



# 五、示例：整条消息从入到出的小流程（时间线）

1. 网关发送 `order-entrance`（key=symbol）到 Kafka。
    
2. 撮合服务 Consumer 收到消息并 publish 到 Disruptor ring（封装为 `MatchEvent`，包含 kafkaOffset）。
    
3. `ValidationHandler` 校验并去重。
    
4. `WalAppendHandler` 将 `ADD_ORDER` intent 写 WAL（返回 walseq=1001）。
    
5. `OrderbookApplyHandler` 执行撮合，产生 trade T1（walseq=1002）并更新内存 book。
    
6. `MatchPostProcessHandler` 构造 `TRADE`、`ORDER_UPDATE` 消息（带 tradeId、walseq）。

7. `OutboundPublisherHandler` 批量 send 到 `trades`、`order-updates` topics，并提交 kafka consumer offset（ack 入单 topic）。
    
8. 清结算服务按 accountId 消费 `trades` 做账并最终发送 `settlement-confirmations`。




RocksDB作为热存储   KV存储引擎 写多读少的场景 LSM-TREE
MINIIO作为冷备份 


|   |   |
|---|---|
|撮合引擎本地持久化|**RocksDB（核心）**|

|   |   |
|---|---|
|快照归档 & 容灾|**MinIO / S3**|

|           |                |
| --------- | -------------- |
| 行情深度/缓存查询 | **Redis（辅助层）** |
